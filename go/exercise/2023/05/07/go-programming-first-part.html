<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Solutions to the exercises from the book The Go Programming Language (First Part)</h1><p class="page-description">Solutions to the exercises from the book The Go Programming Language: First Part</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2023-05-07T00:00:00-05:00" itemprop="datePublished">
        May 7, 2023
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      11 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#go">go</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#exercise">exercise</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
</ul><p>In this article, we will review solutions to the exercises presented in the first part of the book “The Go Programming Language” by Alan A.A. Donovan and Brain W. Kernighan. In an effort to refresh my knowledge, I have re-read this book and decided to complete all the exercises provided in it. I am delighted to share my solutions and receive feedback and comments on my code from other users. If you have any suggestions or improvements to my code, I would greatly appreciate your feedback.</p>

<p><em>Exercise 1.1: Modify the echo program to also print os.Args[0], the name of the command that invoked it.</em></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
 <span class="s">"fmt"</span>
 <span class="s">"os"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">s</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span> <span class="p">{</span>
  <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>Exercise 1.2: Modify the echo program to print the index and value of each of its arguments, one per line.</em></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
   <span class="s">"fmt"</span>
   <span class="s">"os"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span> <span class="p">{</span>
      <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s">" - "</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Exercise 1.3: Experiment to measure the difference in running time between our potentially inefficient versions and the one that uses strings.Join.*</li>
</ul>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
 <span class="s">"fmt"</span>
 <span class="s">"os"</span>
 <span class="s">"strings"</span>
 <span class="s">"time"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

 <span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>

 <span class="k">var</span> <span class="n">s</span><span class="p">,</span> <span class="n">sep</span> <span class="kt">string</span>
 <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
  <span class="n">s</span> <span class="o">+=</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
  <span class="n">sep</span> <span class="o">=</span> <span class="s">" "</span>
 <span class="p">}</span>
 <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

 <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"First time: "</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">Microseconds</span><span class="p">(),</span> <span class="s">"ms"</span><span class="p">)</span>

 <span class="n">start1</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>

 <span class="n">s1</span><span class="p">,</span> <span class="n">sep1</span> <span class="o">:=</span> <span class="s">""</span><span class="p">,</span> <span class="s">""</span>
 <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">arg</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]</span> <span class="p">{</span>
  <span class="n">s1</span> <span class="o">+=</span> <span class="n">sep1</span> <span class="o">+</span> <span class="n">arg</span>
  <span class="n">sep</span> <span class="o">=</span> <span class="s">" "</span>
 <span class="p">}</span>
 <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

 <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Second time: "</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start1</span><span class="p">)</span><span class="o">.</span><span class="n">Microseconds</span><span class="p">(),</span> <span class="s">"ms"</span><span class="p">)</span>

 <span class="n">start2</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>

 <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">strings</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">],</span> <span class="s">" "</span><span class="p">))</span>

 <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"First time: "</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start2</span><span class="p">)</span><span class="o">.</span><span class="n">Microseconds</span><span class="p">(),</span> <span class="s">"ms"</span><span class="p">)</span>

<span class="p">}</span>
</code></pre></div></div>

<p><em>Exercise 1.4: Modify dup2 to print the names of all files in which each duplicated line occurs.</em></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
   <span class="s">"bufio"</span>
   <span class="s">"fmt"</span>
   <span class="s">"os"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">counts</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span>
   <span class="n">filesName</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">string</span><span class="p">)</span>
   <span class="n">files</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]</span>
   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
      <span class="n">countLines</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdin</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">filesName</span><span class="p">)</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">arg</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">files</span> <span class="p">{</span>
         <span class="n">f</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stderr</span><span class="p">,</span> <span class="s">"dup2: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">continue</span>
         <span class="p">}</span>
         <span class="n">countLines</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">filesName</span><span class="p">)</span>
         <span class="n">f</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">counts</span> <span class="p">{</span>
      <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="m">1</span> <span class="p">{</span>
         <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">j</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">filesName</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="p">{</span>
            <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">countLines</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span><span class="n">os</span><span class="o">.</span><span class="n">File</span><span class="p">,</span> <span class="n">counts</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">,</span> <span class="n">filesName</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">input</span> <span class="o">:=</span> <span class="n">bufio</span><span class="o">.</span><span class="n">NewScanner</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
   <span class="k">for</span> <span class="n">input</span><span class="o">.</span><span class="n">Scan</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">counts</span><span class="p">[</span><span class="n">input</span><span class="o">.</span><span class="n">Text</span><span class="p">()]</span><span class="o">++</span>
      <span class="n">filesName</span><span class="p">[</span><span class="n">input</span><span class="o">.</span><span class="n">Text</span><span class="p">()]</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">filesName</span><span class="p">[</span><span class="n">input</span><span class="o">.</span><span class="n">Text</span><span class="p">()],</span> <span class="n">f</span><span class="o">.</span><span class="n">Name</span><span class="p">())</span>
   <span class="p">}</span>
   <span class="c">// NOTE: ignoring potential errors from input.Err()</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>Exercise 1.5: Change the Lissajous program’s color palette to green on black, for added authenticity. To create the web color #RRGGBB, use color.RGBA{0xRR, 0xGG, 0xBB, 0xff}, where each pair of hexadecimal digits represents the intensity of the red, green, or blue component of the pixel.</em></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
   <span class="s">"image"</span>
   <span class="s">"image/color"</span>
   <span class="s">"image/gif"</span>
   <span class="s">"io"</span>
   <span class="s">"log"</span>
   <span class="s">"math"</span>
   <span class="s">"math/rand"</span>
   <span class="s">"net/http"</span>
   <span class="s">"os"</span>
   <span class="s">"time"</span>
<span class="p">)</span>

<span class="c">// var palette = []color.Color{color.White, color.Black}</span>
<span class="k">var</span> <span class="n">palette</span> <span class="o">=</span> <span class="p">[]</span><span class="n">color</span><span class="o">.</span><span class="n">Color</span><span class="p">{</span><span class="n">color</span><span class="o">.</span><span class="n">RGBA</span><span class="p">{</span>
   <span class="n">R</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span>
   <span class="n">G</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span>
   <span class="n">B</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span>
   <span class="n">A</span><span class="o">:</span> <span class="m">255</span><span class="p">,</span>
<span class="p">},</span> <span class="n">color</span><span class="o">.</span><span class="n">RGBA</span><span class="p">{</span>
   <span class="n">R</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span>
   <span class="n">G</span><span class="o">:</span> <span class="m">255</span><span class="p">,</span>
   <span class="n">B</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span>
   <span class="n">A</span><span class="o">:</span> <span class="m">255</span><span class="p">,</span>
<span class="p">}}</span>

<span class="k">const</span> <span class="p">(</span>
   <span class="n">whiteIndex</span> <span class="o">=</span> <span class="m">0</span> <span class="c">// first color in palette</span>
   <span class="n">blackIndex</span> <span class="o">=</span> <span class="m">1</span> <span class="c">// next color in palette</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
   <span class="c">//!-main</span>
   <span class="c">// The sequence of images is deterministic unless we seed</span>
   <span class="c">// the pseudo-random number generator using the current time.</span>
   <span class="c">// Thanks to Randall McPherson for pointing out the omission.</span>
   <span class="n">rand</span><span class="o">.</span><span class="n">Seed</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">UTC</span><span class="p">()</span><span class="o">.</span><span class="n">UnixNano</span><span class="p">())</span>

   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">1</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">"web"</span> <span class="p">{</span>
      <span class="c">//!+http</span>
      <span class="n">handler</span> <span class="o">:=</span> <span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">lissajousgreen</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="n">http</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
      <span class="c">//!-http</span>
      <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">"localhost:8000"</span><span class="p">,</span> <span class="no">nil</span><span class="p">))</span>
      <span class="k">return</span>
   <span class="p">}</span>
   <span class="c">//!+main</span>
   <span class="n">lissajousgreen</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">lissajousgreen</span><span class="p">(</span><span class="n">out</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">const</span> <span class="p">(</span>
      <span class="n">cycles</span>  <span class="o">=</span> <span class="m">5</span>     <span class="c">// number of complete x oscillator revolutions</span>
      <span class="n">res</span>     <span class="o">=</span> <span class="m">0.001</span> <span class="c">// angular resolution</span>
      <span class="n">size</span>    <span class="o">=</span> <span class="m">100</span>   <span class="c">// image canvas covers [-size..+size]</span>
      <span class="n">nframes</span> <span class="o">=</span> <span class="m">64</span>    <span class="c">// number of animation frames</span>
      <span class="n">delay</span>   <span class="o">=</span> <span class="m">8</span>     <span class="c">// delay between frames in 10ms units</span>
   <span class="p">)</span>
   <span class="n">freq</span> <span class="o">:=</span> <span class="n">rand</span><span class="o">.</span><span class="n">Float64</span><span class="p">()</span> <span class="o">*</span> <span class="m">3.0</span> <span class="c">// relative frequency of y oscillator</span>
   <span class="n">anim</span> <span class="o">:=</span> <span class="n">gif</span><span class="o">.</span><span class="n">GIF</span><span class="p">{</span><span class="n">LoopCount</span><span class="o">:</span> <span class="n">nframes</span><span class="p">}</span>
   <span class="n">phase</span> <span class="o">:=</span> <span class="m">0.0</span> <span class="c">// phase difference</span>
   <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nframes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
      <span class="n">rect</span> <span class="o">:=</span> <span class="n">image</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">2</span><span class="o">*</span><span class="n">size</span><span class="o">+</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="o">*</span><span class="n">size</span><span class="o">+</span><span class="m">1</span><span class="p">)</span>
      <span class="n">img</span> <span class="o">:=</span> <span class="n">image</span><span class="o">.</span><span class="n">NewPaletted</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">palette</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">t</span> <span class="o">:=</span> <span class="m">0.0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">cycles</span><span class="o">*</span><span class="m">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">Pi</span><span class="p">;</span> <span class="n">t</span> <span class="o">+=</span> <span class="n">res</span> <span class="p">{</span>
         <span class="n">x</span> <span class="o">:=</span> <span class="n">math</span><span class="o">.</span><span class="n">Sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
         <span class="n">y</span> <span class="o">:=</span> <span class="n">math</span><span class="o">.</span><span class="n">Sin</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">freq</span> <span class="o">+</span> <span class="n">phase</span><span class="p">)</span>
         <span class="n">img</span><span class="o">.</span><span class="n">SetColorIndex</span><span class="p">(</span><span class="n">size</span><span class="o">+</span><span class="kt">int</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="o">+</span><span class="m">0.5</span><span class="p">),</span> <span class="n">size</span><span class="o">+</span><span class="kt">int</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="o">+</span><span class="m">0.5</span><span class="p">),</span>
            <span class="n">blackIndex</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="n">phase</span> <span class="o">+=</span> <span class="m">0.1</span>
      <span class="n">anim</span><span class="o">.</span><span class="n">Delay</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">anim</span><span class="o">.</span><span class="n">Delay</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
      <span class="n">anim</span><span class="o">.</span><span class="n">Image</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">anim</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="n">gif</span><span class="o">.</span><span class="n">EncodeAll</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">anim</span><span class="p">)</span> <span class="c">// NOTE: ignoring encoding errors</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>Exercise 1.6: Modify the Lissajous program to produce images in multiple colors by adding more values to palette and then displaying them by changing the third argument of SetColorIndex in some interesting way.</em></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
   <span class="s">"image"</span>
   <span class="s">"image/color"</span>
   <span class="s">"image/gif"</span>
   <span class="s">"io"</span>
   <span class="s">"log"</span>
   <span class="s">"math"</span>
   <span class="s">"math/rand"</span>
   <span class="s">"net/http"</span>
   <span class="s">"os"</span>
   <span class="s">"time"</span>
<span class="p">)</span>

<span class="k">var</span> <span class="n">palette</span> <span class="o">=</span> <span class="p">[]</span><span class="n">color</span><span class="o">.</span><span class="n">Color</span><span class="p">{</span>
   <span class="n">color</span><span class="o">.</span><span class="n">White</span><span class="p">,</span>
   <span class="n">color</span><span class="o">.</span><span class="n">RGBA</span><span class="p">{</span><span class="n">R</span><span class="o">:</span> <span class="m">255</span><span class="p">,</span> <span class="n">A</span><span class="o">:</span> <span class="m">255</span><span class="p">},</span>
   <span class="n">color</span><span class="o">.</span><span class="n">RGBA</span><span class="p">{</span><span class="n">G</span><span class="o">:</span> <span class="m">255</span><span class="p">,</span> <span class="n">A</span><span class="o">:</span> <span class="m">255</span><span class="p">},</span>
   <span class="n">color</span><span class="o">.</span><span class="n">RGBA</span><span class="p">{</span><span class="n">B</span><span class="o">:</span> <span class="m">255</span><span class="p">,</span> <span class="n">A</span><span class="o">:</span> <span class="m">255</span><span class="p">},</span>
   <span class="n">color</span><span class="o">.</span><span class="n">Black</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">const</span> <span class="p">(</span>
   <span class="n">whiteIndex</span> <span class="o">=</span> <span class="m">0</span> <span class="c">// first color in palette</span>
   <span class="n">blackIndex</span> <span class="o">=</span> <span class="m">1</span> <span class="c">// next color in palette</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
   <span class="c">//!-main</span>
   <span class="c">// The sequence of images is deterministic unless we seed</span>
   <span class="c">// the pseudo-random number generator using the current time.</span>
   <span class="c">// Thanks to Randall McPherson for pointing out the omission.</span>
   <span class="n">rand</span><span class="o">.</span><span class="n">Seed</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">UTC</span><span class="p">()</span><span class="o">.</span><span class="n">UnixNano</span><span class="p">())</span>

   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">1</span> <span class="o">&amp;&amp;</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">"web"</span> <span class="p">{</span>
      <span class="c">//!+http</span>
      <span class="n">handler</span> <span class="o">:=</span> <span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">lissajous</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="n">http</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
      <span class="c">//!-http</span>
      <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">"localhost:8000"</span><span class="p">,</span> <span class="no">nil</span><span class="p">))</span>
      <span class="k">return</span>
   <span class="p">}</span>
   <span class="c">//!+main</span>
   <span class="n">lissajous</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">lissajous</span><span class="p">(</span><span class="n">out</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">const</span> <span class="p">(</span>
      <span class="n">cycles</span>  <span class="o">=</span> <span class="m">5</span>     <span class="c">// number of complete x oscillator revolutions</span>
      <span class="n">res</span>     <span class="o">=</span> <span class="m">0.001</span> <span class="c">// angular resolution</span>
      <span class="n">size</span>    <span class="o">=</span> <span class="m">100</span>   <span class="c">// image canvas covers [-size..+size]</span>
      <span class="n">nframes</span> <span class="o">=</span> <span class="m">64</span>    <span class="c">// number of animation frames</span>
      <span class="n">delay</span>   <span class="o">=</span> <span class="m">8</span>     <span class="c">// delay between frames in 10ms units</span>
   <span class="p">)</span>
   <span class="n">freq</span> <span class="o">:=</span> <span class="n">rand</span><span class="o">.</span><span class="n">Float64</span><span class="p">()</span> <span class="o">*</span> <span class="m">3.0</span> <span class="c">// relative frequency of y oscillator</span>
   <span class="n">anim</span> <span class="o">:=</span> <span class="n">gif</span><span class="o">.</span><span class="n">GIF</span><span class="p">{</span><span class="n">LoopCount</span><span class="o">:</span> <span class="n">nframes</span><span class="p">}</span>
   <span class="n">phase</span> <span class="o">:=</span> <span class="m">0.0</span> <span class="c">// phase difference</span>
   <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nframes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
      <span class="n">rect</span> <span class="o">:=</span> <span class="n">image</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">2</span><span class="o">*</span><span class="n">size</span><span class="o">+</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="o">*</span><span class="n">size</span><span class="o">+</span><span class="m">1</span><span class="p">)</span>
      <span class="n">img</span> <span class="o">:=</span> <span class="n">image</span><span class="o">.</span><span class="n">NewPaletted</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">palette</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">t</span> <span class="o">:=</span> <span class="m">0.0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">cycles</span><span class="o">*</span><span class="m">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">Pi</span><span class="p">;</span> <span class="n">t</span> <span class="o">+=</span> <span class="n">res</span> <span class="p">{</span>
         <span class="n">x</span> <span class="o">:=</span> <span class="n">math</span><span class="o">.</span><span class="n">Sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
         <span class="n">y</span> <span class="o">:=</span> <span class="n">math</span><span class="o">.</span><span class="n">Sin</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">freq</span> <span class="o">+</span> <span class="n">phase</span><span class="p">)</span>

         <span class="n">tmpIndex</span> <span class="o">:=</span> <span class="kt">uint8</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">))</span>

         <span class="n">img</span><span class="o">.</span><span class="n">SetColorIndex</span><span class="p">(</span><span class="n">size</span><span class="o">+</span><span class="kt">int</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="o">+</span><span class="m">0.5</span><span class="p">),</span> <span class="n">size</span><span class="o">+</span><span class="kt">int</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="o">+</span><span class="m">0.5</span><span class="p">),</span>
            <span class="n">tmpIndex</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="n">phase</span> <span class="o">+=</span> <span class="m">0.1</span>
      <span class="n">anim</span><span class="o">.</span><span class="n">Delay</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">anim</span><span class="o">.</span><span class="n">Delay</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
      <span class="n">anim</span><span class="o">.</span><span class="n">Image</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">anim</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="n">gif</span><span class="o">.</span><span class="n">EncodeAll</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">anim</span><span class="p">)</span> <span class="c">// NOTE: ignoring encoding errors</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>Exercise 1.7: The function call io.Copy(dst, src) reads from src and writes to dst. Use it instead of ioutil.ReadAll to copy the response body to os.Stdout without requiring a buffer large enough to hold the entire stream. Be sure to check the error result of io.Copy.</em></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
 <span class="s">"fmt"</span>
 <span class="s">"io"</span>
 <span class="s">"log"</span>
 <span class="s">"net/http"</span>
 <span class="s">"os"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">url</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]</span> <span class="p">{</span>
  <span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
   <span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stderr</span><span class="p">,</span> <span class="s">"fetch: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
   <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
   <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
   <span class="n">b</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">io</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stderr</span><span class="p">,</span> <span class="s">"fetch: reading %s: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

 <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>Exercise 1.8: Modify fetch to add the prefix http:// to each argument URL if it is missing. You might want to use strings.HasPrefix</em></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
 <span class="s">"fmt"</span>
 <span class="s">"io"</span>
 <span class="s">"log"</span>
 <span class="s">"net/http"</span>
 <span class="s">"os"</span>
 <span class="s">"strings"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">url</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">strings</span><span class="o">.</span><span class="n">HasPrefix</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">"http://"</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">url</span> <span class="o">=</span> <span class="s">"http://"</span> <span class="o">+</span> <span class="n">url</span>
  <span class="p">}</span>
  <span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
   <span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stderr</span><span class="p">,</span> <span class="s">"fetch: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
   <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
   <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
   <span class="n">b</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">io</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stderr</span><span class="p">,</span> <span class="s">"fetch: reading %s: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>Exercise 1.9: Modify fetch to also print the HTTP status code, found in resp.Status.</em></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
 <span class="s">"fmt"</span>
 <span class="s">"net/http"</span>
 <span class="s">"os"</span>
 <span class="s">"strings"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">url</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">strings</span><span class="o">.</span><span class="n">HasPrefix</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">"http://"</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">url</span> <span class="o">=</span> <span class="s">"http://"</span> <span class="o">+</span> <span class="n">url</span>
  <span class="p">}</span>
  <span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
   <span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stderr</span><span class="p">,</span> <span class="s">"fetch: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
   <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">defer</span> <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

  <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"STATUS CODE"</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">StatusCode</span><span class="p">)</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>Exercise 1.10: Find a web site that produces a large amount of data. Investigate caching by running fetchall twice in succession to see whether the reported time changes much. Do you get the same content each time? Modify fetchall to print its output to a file so it can be examined.</em></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
 <span class="s">"fmt"</span>
 <span class="s">"io"</span>
 <span class="s">"log"</span>
 <span class="s">"net/http"</span>
 <span class="s">"os"</span>
 <span class="s">"strings"</span>
 <span class="s">"time"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
 <span class="n">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">string</span><span class="p">)</span>
 <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">url</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">go</span> <span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span> <span class="c">// start a goroutine</span>
  <span class="k">go</span> <span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="k">for</span> <span class="k">range</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]</span> <span class="p">{</span>
  <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="o">&lt;-</span><span class="n">ch</span><span class="p">)</span> <span class="c">// receive from channel ch</span>
  <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="o">&lt;-</span><span class="n">ch</span><span class="p">)</span> <span class="c">// receive from channel ch</span>
 <span class="p">}</span>
 <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%.2fs elapsed</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">Seconds</span><span class="p">())</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">fetch</span><span class="p">(</span><span class="n">url</span> <span class="kt">string</span><span class="p">,</span> <span class="n">ch</span> <span class="k">chan</span><span class="o">&lt;-</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
 <span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
 <span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
 <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprint</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="c">// send to channel ch</span>
  <span class="k">return</span>
 <span class="p">}</span>

 <span class="n">f</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">strings</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">"."</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">".txt"</span><span class="p">)</span>
 <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Can't create file"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="k">defer</span> <span class="n">f</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

 <span class="n">nbytes</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">io</span><span class="o">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span>
 <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span> <span class="c">// don't leak resources</span>
 <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"while reading %s: %v"</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
  <span class="k">return</span>
 <span class="p">}</span>
 <span class="n">secs</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">Seconds</span><span class="p">()</span>
 <span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%.2fs  %7d  %s"</span><span class="p">,</span> <span class="n">secs</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>Exercise 1.11: Try fetchall with longer argument lists, such as samples from the top million web sites available at alexa.com. How does the program behave if a web site just doesn’t respond?</em></p>

<p>The information I needed was not available on alexa.com, so I downloaded a file from kaggle.com.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
 <span class="s">"encoding/csv"</span>
 <span class="s">"fmt"</span>
 <span class="s">"io"</span>
 <span class="s">"log"</span>
 <span class="s">"net/http"</span>
 <span class="s">"os"</span>
 <span class="s">"strings"</span>
 <span class="s">"time"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">readCSVFile</span><span class="p">(</span><span class="n">filePath</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[][]</span><span class="kt">string</span> <span class="p">{</span>
 <span class="n">f</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
 <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s">"Unable to read input file "</span><span class="o">+</span><span class="n">filePath</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="k">defer</span> <span class="n">f</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

 <span class="n">csvReader</span> <span class="o">:=</span> <span class="n">csv</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
 <span class="n">records</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">csvReader</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">()</span>

 <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s">"Unable to parse file as CSV for "</span><span class="o">+</span><span class="n">filePath</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
 <span class="p">}</span>

 <span class="k">return</span> <span class="n">records</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">fetch</span><span class="p">(</span><span class="n">url</span> <span class="kt">string</span><span class="p">,</span> <span class="n">ch</span> <span class="k">chan</span><span class="o">&lt;-</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
 <span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
 <span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
 <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprint</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="c">// send to channel ch</span>
  <span class="k">return</span>
 <span class="p">}</span>

 <span class="n">nbytes</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">io</span><span class="o">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">Discard</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span>
 <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span> <span class="c">// don't leak resources</span>
 <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"while reading %s: %v"</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
  <span class="k">return</span>
 <span class="p">}</span>
 <span class="n">secs</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">Seconds</span><span class="p">()</span>
 <span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%.2fs  %7d  %s"</span><span class="p">,</span> <span class="n">secs</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
 <span class="n">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">string</span><span class="p">)</span>
 <span class="n">records</span> <span class="o">:=</span> <span class="n">readCSVFile</span><span class="p">(</span><span class="s">"top-1m.csv"</span><span class="p">)</span>
 <span class="n">url</span> <span class="o">:=</span> <span class="s">""</span>
 <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">numberURL</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">records</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">strings</span><span class="o">.</span><span class="n">HasPrefix</span><span class="p">(</span><span class="n">numberURL</span><span class="p">[</span><span class="m">1</span><span class="p">],</span> <span class="s">"http://"</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">url</span> <span class="o">=</span> <span class="s">"http://"</span> <span class="o">+</span> <span class="n">numberURL</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
   <span class="n">url</span> <span class="o">=</span> <span class="n">numberURL</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>
  <span class="p">}</span>
  <span class="k">go</span> <span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
 <span class="p">}</span>

 <span class="k">for</span> <span class="k">range</span> <span class="n">records</span> <span class="p">{</span>
  <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="o">&lt;-</span><span class="n">ch</span><span class="p">)</span>
 <span class="p">}</span>

 <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%.2fs elapsed</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">Seconds</span><span class="p">())</span>

<span class="p">}</span>
</code></pre></div></div>

<p><em>Exercise 1.12: Modify the Lissajous server to read parameter values from the URL. For example, you might arrange it so that a URL like http://localhost:8000/?cycles=20 sets the number of cycles to 20 instead of the default 5. Use the strconv.Atoi function to convert the string parameter into an integer. You can see its documentation with go doc strconv.Atoi.</em></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
   <span class="s">"image"</span>
   <span class="s">"image/color"</span>
   <span class="s">"image/gif"</span>
   <span class="s">"io"</span>
   <span class="s">"log"</span>
   <span class="s">"math"</span>
   <span class="s">"math/rand"</span>
   <span class="s">"net/http"</span>
   <span class="s">"net/url"</span>
   <span class="s">"strconv"</span>
<span class="p">)</span>

<span class="k">var</span> <span class="n">palette</span> <span class="o">=</span> <span class="p">[]</span><span class="n">color</span><span class="o">.</span><span class="n">Color</span><span class="p">{</span>
   <span class="n">color</span><span class="o">.</span><span class="n">White</span><span class="p">,</span>
   <span class="n">color</span><span class="o">.</span><span class="n">RGBA</span><span class="p">{</span><span class="n">R</span><span class="o">:</span> <span class="m">255</span><span class="p">,</span> <span class="n">A</span><span class="o">:</span> <span class="m">255</span><span class="p">},</span>
   <span class="n">color</span><span class="o">.</span><span class="n">RGBA</span><span class="p">{</span><span class="n">G</span><span class="o">:</span> <span class="m">255</span><span class="p">,</span> <span class="n">A</span><span class="o">:</span> <span class="m">255</span><span class="p">},</span>
   <span class="n">color</span><span class="o">.</span><span class="n">RGBA</span><span class="p">{</span><span class="n">B</span><span class="o">:</span> <span class="m">255</span><span class="p">,</span> <span class="n">A</span><span class="o">:</span> <span class="m">255</span><span class="p">},</span>
   <span class="n">color</span><span class="o">.</span><span class="n">Black</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">const</span> <span class="p">(</span>
   <span class="n">whiteIndex</span> <span class="o">=</span> <span class="m">0</span> <span class="c">// first color in palette</span>
   <span class="n">blackIndex</span> <span class="o">=</span> <span class="m">1</span> <span class="c">// next color in palette</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">handler</span> <span class="o">:=</span> <span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">lissajous</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="n">http</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
   <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">"localhost:8070"</span><span class="p">,</span> <span class="no">nil</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">lissajous</span><span class="p">(</span><span class="n">out</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">const</span> <span class="p">(</span>
      <span class="n">res</span>     <span class="o">=</span> <span class="m">0.001</span> <span class="c">// angular resolution</span>
      <span class="n">size</span>    <span class="o">=</span> <span class="m">100</span>   <span class="c">// image canvas covers [-size..+size]</span>
      <span class="n">nframes</span> <span class="o">=</span> <span class="m">64</span>    <span class="c">// number of animation frames</span>
      <span class="n">delay</span>   <span class="o">=</span> <span class="m">8</span>     <span class="c">// delay between frames in 10ms units</span>
   <span class="p">)</span>
   <span class="k">var</span> <span class="n">cycles</span> <span class="o">=</span> <span class="m">5</span> <span class="c">// number of complete x oscillator revolutions</span>
   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Header</span><span class="p">[</span><span class="s">"Referer"</span><span class="p">])</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
      <span class="n">u</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">url</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Header</span><span class="p">[</span><span class="s">"Referer"</span><span class="p">][</span><span class="m">0</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
         <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="n">cyclesStr</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">url</span><span class="o">.</span><span class="n">ParseQuery</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">RawQuery</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">cyclesStr</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"cycles"</span><span class="p">)</span> <span class="o">!=</span> <span class="s">""</span> <span class="p">{</span>
         <span class="n">cycles</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">cyclesStr</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"cycles"</span><span class="p">))</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="n">freq</span> <span class="o">:=</span> <span class="n">rand</span><span class="o">.</span><span class="n">Float64</span><span class="p">()</span> <span class="o">*</span> <span class="m">3.0</span> <span class="c">// relative frequency of y oscillator</span>
   <span class="n">anim</span> <span class="o">:=</span> <span class="n">gif</span><span class="o">.</span><span class="n">GIF</span><span class="p">{</span><span class="n">LoopCount</span><span class="o">:</span> <span class="n">nframes</span><span class="p">}</span>
   <span class="n">phase</span> <span class="o">:=</span> <span class="m">0.0</span> <span class="c">// phase difference</span>
   <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nframes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
      <span class="n">rect</span> <span class="o">:=</span> <span class="n">image</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">2</span><span class="o">*</span><span class="n">size</span><span class="o">+</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="o">*</span><span class="n">size</span><span class="o">+</span><span class="m">1</span><span class="p">)</span>
      <span class="n">img</span> <span class="o">:=</span> <span class="n">image</span><span class="o">.</span><span class="n">NewPaletted</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">palette</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">t</span> <span class="o">:=</span> <span class="m">0.0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="kt">float64</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span><span class="o">*</span><span class="m">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">Pi</span><span class="p">;</span> <span class="n">t</span> <span class="o">+=</span> <span class="n">res</span> <span class="p">{</span>
         <span class="n">x</span> <span class="o">:=</span> <span class="n">math</span><span class="o">.</span><span class="n">Sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
         <span class="n">y</span> <span class="o">:=</span> <span class="n">math</span><span class="o">.</span><span class="n">Sin</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">freq</span> <span class="o">+</span> <span class="n">phase</span><span class="p">)</span>
         <span class="n">img</span><span class="o">.</span><span class="n">SetColorIndex</span><span class="p">(</span><span class="n">size</span><span class="o">+</span><span class="kt">int</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="o">+</span><span class="m">0.5</span><span class="p">),</span> <span class="n">size</span><span class="o">+</span><span class="kt">int</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="o">+</span><span class="m">0.5</span><span class="p">),</span>
            <span class="n">blackIndex</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="n">phase</span> <span class="o">+=</span> <span class="m">0.1</span>
      <span class="n">anim</span><span class="o">.</span><span class="n">Delay</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">anim</span><span class="o">.</span><span class="n">Delay</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
      <span class="n">anim</span><span class="o">.</span><span class="n">Image</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">anim</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="n">gif</span><span class="o">.</span><span class="n">EncodeAll</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">anim</span><span class="p">)</span> <span class="c">// NOTE: ignoring encoding errors</span>
<span class="p">}</span>
</code></pre></div></div>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="Zmey56/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/go/exercise/2023/05/07/go-programming-first-part.html" hidden></a>
</article>