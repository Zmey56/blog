<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Automation of reporting Part 2 | alex.gladkikh.org</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Automation of reporting Part 2" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Automation of reporting Part 2" />
<meta property="og:description" content="Automation of reporting Part 2" />
<link rel="canonical" href="https://zmey56.github.io/blog//data%20analysis/mysql/gitlab/telegram/bot/2022/09/02/Automation-of-reporting-copy-Part-2.html" />
<meta property="og:url" content="https://zmey56.github.io/blog//data%20analysis/mysql/gitlab/telegram/bot/2022/09/02/Automation-of-reporting-copy-Part-2.html" />
<meta property="og:site_name" content="alex.gladkikh.org" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-02T00:00:00-05:00" />
<script type="application/ld+json">
{"url":"https://zmey56.github.io/blog//data%20analysis/mysql/gitlab/telegram/bot/2022/09/02/Automation-of-reporting-copy-Part-2.html","@type":"BlogPosting","headline":"Automation of reporting Part 2","dateModified":"2022-09-02T00:00:00-05:00","datePublished":"2022-09-02T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://zmey56.github.io/blog//data%20analysis/mysql/gitlab/telegram/bot/2022/09/02/Automation-of-reporting-copy-Part-2.html"},"description":"Automation of reporting Part 2","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://zmey56.github.io/blog//feed.xml" title="alex.gladkikh.org" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-183752218-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">alex.gladkikh.org</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Automation of reporting Part 2</h1><p class="page-description">Automation of reporting Part 2</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-09-02T00:00:00-05:00" itemprop="datePublished">
        Sep 2, 2022
      </time>
       ‚Ä¢ <span class="read-time" title="Estimated read time">
    
    
      16 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#data analysis">data analysis</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#mysql">mysql</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#gitlab">gitlab</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#telegram">telegram</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#bot">bot</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
</ul><p>I continue my publications on analytics:</p>

<ul>
  <li><a href="https://alex.gladkikh.org/data%20analysis/mysql/superset/bi/2022/08/03/the-first-dashboard.html">A Data Analysis in business‚Ää-‚ÄäBI system and visualisation</a></li>
  <li><a href="https://alex.gladkikh.org/data%20analysis/mysql/superset/bi/2022/08/05/analyses-of-product-metrics.html">Analyses of Product Metrics</a></li>
  <li><a href="https://alex.gladkikh.org/data%20analysis/ab-test/aa-test/2022/08/09/aa-test-article.html">–ê/B-tests‚Ää-‚ÄäPart 1/3(AA-test)</a></li>
  <li><a href="https://alex.gladkikh.org/data%20analysis/ab-test/aa-test/2022/08/11/ab-test-article.html">–ê/B-tests‚Ää-‚ÄäPart 2/3(AB-test)</a></li>
  <li><a href="https://alex.gladkikh.org/data%20analysis/ab-test/metrics/2022/08/15/ab-test-article-metrics.html">A/B-tests‚Ää-‚ÄäPart 3/3 (relationship metrics)</a></li>
  <li><a href="https://alex.gladkikh.org/data%20analysis/mysql/airflow/etl/2022/08/19/Building-ETL-Pipeline-Airflow.html">Building an ETL-Pipeline (Airflow)</a></li>
  <li><a href="https://alex.gladkikh.org/data%20analysis/mysql/gitlab/telegram/bot/2022/08/24/Automation-of-reporting.html">Automation of reporting Part 1</a></li>
</ul>

<p>Next, we needed to collect a single report on the operation of the entire application. The report should have included information on both the news feed and the message sending service. The report should arrive daily at 11:00 in the chat.</p>

<p>In the first step, we import all the necessary libraries and define the necessary variables. We also define the token of our bot, as we will need it for testing. Then we will hide it on GitLab, as we did in the last part:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">telegram</span>
<span class="kn">import</span> <span class="nn">pandahouse</span> <span class="k">as</span> <span class="n">ph</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="n">sns</span><span class="p">.</span><span class="nb">set</span><span class="p">()</span>

<span class="n">sns</span><span class="p">.</span><span class="nb">set</span><span class="p">()</span>
<span class="n">my_token</span> <span class="o">=</span> <span class="s">"**************************************"</span>

<span class="n">chat_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1001592565485</span>

<span class="n">connection</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'host'</span><span class="p">:</span> <span class="s">'https://clickhouse.lab.karpov.courses'</span><span class="p">,</span>
    <span class="s">'password'</span><span class="p">:</span> <span class="s">'************'</span><span class="p">,</span>
    <span class="s">'user'</span><span class="p">:</span> <span class="s">'***********'</span><span class="p">,</span>
    <span class="s">'database'</span><span class="p">:</span> <span class="s">'simulator_20220620'</span><span class="p">}</span>
</code></pre></div></div>

<p>Next, we form a text message that will be displayed in the report:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">msg</span> <span class="o">=</span> <span class="s">""" üìÉApplication report for {date}üìÉ
        Events: {events}
        üßëDAU: {users}({to_users_day_ago:+.2%} to day ago, {to_users_week_ago:+.2%} to week ago)
        üßëDAU by platform: 
            üì±IOS: {users_ios}({to_users_ios_day_ago:+.2%} to day ago, {to_users_ios_week_ago:+.2%} to week ago)
            üìûAndroid: {users_and}({to_users_and_day_ago:+.2%} to day ago, {to_users_and_week_ago:+.2%} to week ago)
        üë´DAU by gender: 
            üôéMale: {users_male}({to_users_male_day_ago:+.2%} to day ago, {to_users_male_week_ago:+.2%} to week ago)
            üë∞‚ÄçFemale: {users_female}({to_users_female_day_ago:+.2%} to day ago, {to_users_female_week_ago:+.2%} to week ago)
        üßëNew users: {new_users}({to_new_users_day_ago:+.2%} to day ago, {to_new_users_week_ago:+.2%} to week ago)
        üé¨Source:
            üçãads: {new_users_ads}({to_new_users_ads_day_ago:+.2%} to day ago, {to_new_users_ads_week_ago:+.2%} to week ago)
            üçìorganic: {new_users_org}({to_new_users_org_day_ago:+.2%} to day ago, {to_new_users_org_week_ago:+.2%} to week ago)
        
        FEEDS:
        üßëDAU: {users_feed}({to_users_feed_day_ago:+.2%} to day ago, {to_users_feed_week_ago:+.2%} to week ago)
        üëçLikes: {likes}({to_likes_day_ago:+.2%} to day ago, {to_likes_week_ago:+.2%} to week ago)
        üëÄViews: {views}({to_views_day_ago:+.2%} to day ago, {to_views_week_ago:+.2%} to week ago)
        üåàCTR: {ctr:+.2%}({to_ctr_day_ago:+.2%} to day ago, {to_ctr_week_ago:+.2%} to week ago)
        
        MESSENGER:
        üßëDAU: {users_msg}({to_users_msg_day_ago:+.2%} to day ago, {to_users_msg_week_ago:+.2%} to week ago)
        üì®Messages: {msg} ({to_msg_day_ago:+.2%} to day ago, {to_msg_week_ago:+.2%} to week ago)
        ü™™Messages per users: {mpu:.2}({to_mpu_day_ago:+.2%} to day ago, {to_mpu_week_ago:+.2%} to week ago)
        """</span>
</code></pre></div></div>

<p>Now we need to write queries in order to get data for all these metrics. The first request will be a request for the feed:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query_feed_q</span> <span class="o">=</span> <span class="s">"""
                select 
                    toDate(time) as date
                    ,count(distinct user_id) as users_feed
                    ,countIf(action='like') as likes
                    ,countIf(action='view') as views
                    ,countIf(action='like') / countIf(action='view') as CTR
                    ,likes+views as events
                from simulator_20220620.feed_actions
                where toDate(time) between today() - 8 and today() - 1
                group by date
                order by date
                """</span>

<span class="n">data_feed</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ph</span><span class="p">.</span><span class="n">read_clickhouse</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_feed_q</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">))</span>
</code></pre></div></div>

<p>The next request will be a request for a messenger:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query_msg_q</span> <span class="o">=</span> <span class="s">"""
                  select 
                      toDate(time) as date
                      ,count(distinct user_id) as users_msg
                      ,count(user_id) as msg
                      , msg / users_msg as mpu
                  from simulator_20220620.message_actions
                  where toDate(time) between today() - 8 and today() - 1
                  group by date
                  order by date
                  """</span>
<span class="n">data_msg</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ph</span><span class="p">.</span><span class="n">read_clickhouse</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_msg_q</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">))</span>
</code></pre></div></div>

<p>Now there is a big query in general on the platform, where data will be required from two tables:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query_dau_all_q</span> <span class="o">=</span> <span class="s">"""select date, 
                                uniqExact(user_id) as users, 
                                uniqExactIf(user_id, os='iOS') as users_ios, 
                                uniqExactIf(user_id, os='Android') as users_and, 
                                uniqExactIf(user_id, gender=1) as users_male,
                                uniqExactIf(user_id, gender=0) as users_female
                        from
                            (select distinct toDate(time) as date, user_id, os, gender
                            from simulator_20220620.feed_actions
                            where toDate(time) between today() - 8 and today() - 1
                            union all
                            select distinct toDate(time) as date, user_id, os, gender
                            from simulator_20220620.message_actions
                            where toDate(time) between today() - 8 and today() - 1) as t
                        group by date
                        order by date"""</span>

<span class="n">data_dau_all</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ph</span><span class="p">.</span><span class="n">read_clickhouse</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_dau_all_q</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">))</span>
</code></pre></div></div>

<p>Now it remains to find the number of new users. In this request, you need to find the minimum date for each user and count it as the registration date:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_new_users_q</span> <span class="o">=</span> <span class="s">"""
select date, 
        uniqExact(user_id) as new_user, 
        uniqExactIf(user_id, source='ads') as new_user_ads,
        uniqExactIf(user_id, source='organic') as new_user_organic
from(
    select user_id,
            source, 
            min(dt_reg) as date 
    from
        (select user_id, 
                min(toDate(time)) as dt_reg, 
                source
        from simulator_20220620.feed_actions
        where toDate(time) between today() - 8 and today() - 1
        group by user_id, source
        union all
        select user_id,
                min(toDate(time)) as dt_reg, 
                source
        from simulator_20220620.message_actions
        where toDate(time) between today() - 8 and today() - 1
        group by user_id, source) as t1
    group by user_id, source) as t2
group by date
where date between today() - 8 and today() - 1
"""</span>
<span class="n">data_new_users</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ph</span><span class="p">.</span><span class="n">read_clickhouse</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">data_new_users_q</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">))</span>
</code></pre></div></div>

<p>Next, we set variables to work with the date and correct the date and data types for all our dataframes:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]).</span><span class="n">dt</span><span class="p">.</span><span class="n">date</span>
<span class="n">data_msq</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data_msq</span><span class="p">[</span><span class="s">'date'</span><span class="p">]).</span><span class="n">dt</span><span class="p">.</span><span class="n">date</span>
<span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]).</span><span class="n">dt</span><span class="p">.</span><span class="n">date</span>
<span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]).</span><span class="n">dt</span><span class="p">.</span><span class="n">date</span>

<span class="n">data_feed</span> <span class="o">=</span> <span class="n">data_feed</span><span class="p">.</span><span class="n">astype</span><span class="p">({</span><span class="s">'users_feed'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'likes'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'views'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'events'</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
<span class="n">data_msq</span> <span class="o">=</span> <span class="n">data_msq</span><span class="p">.</span><span class="n">astype</span><span class="p">({</span><span class="s">'users_msg'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'msg'</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
<span class="n">data_dau_all</span> <span class="o">=</span> <span class="n">data_dau_all</span><span class="p">.</span><span class="n">astype</span><span class="p">({</span><span class="s">'users'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'users_ios'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'users_and'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'users_male'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'users_female'</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
<span class="n">data_new_users</span> <span class="o">=</span> <span class="n">data_new_users</span><span class="p">.</span><span class="n">astype</span><span class="p">({</span><span class="s">'new_user'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'new_user_ads'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'new_user_organic'</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>

<span class="n">today</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s">'now'</span><span class="p">)</span> <span class="o">-</span> <span class="n">pd</span><span class="p">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">day_ago</span> <span class="o">=</span> <span class="n">today</span> <span class="o">-</span> <span class="n">pd</span><span class="p">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">week_ago</span> <span class="o">=</span> <span class="n">today</span> <span class="o">-</span> <span class="n">pd</span><span class="p">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</code></pre></div></div>

<p>Now fill in the text template:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">report</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">(),</span>
                        <span class="n">events</span><span class="o">=</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'events'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">users</span><span class="o">=</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_day_ago</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                           <span class="o">/</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_week_ago</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                           <span class="o">/</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">users_ios</span><span class="o">=</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_ios'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_ios_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_ios'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                          <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_ios'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                         <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_ios'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_ios_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_ios'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_ios'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                          <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_ios'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">users_and</span><span class="o">=</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_and'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_and_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_and'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                   <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_and'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                  <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_and'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_and_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_and'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                               <span class="o">-</span>
                                               <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_and'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                   <span class="mi">0</span><span class="p">])</span>
                                              <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_and'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                  <span class="mi">0</span><span class="p">],</span>

                        <span class="n">users_male</span><span class="o">=</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_male'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_male_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_male'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                   <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_male'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                  <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_male'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_male_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_male'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                               <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_male'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                              <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_male'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">users_female</span><span class="o">=</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_female'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_female_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_female'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                   <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_female'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                  <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_female'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_female_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_female'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                               <span class="o">-</span>
                                               <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_female'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                   <span class="mi">0</span><span class="p">])</span>
                                              <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_female'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                  <span class="mi">0</span><span class="p">],</span>

                        <span class="n">new_users</span><span class="o">=</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_new_users_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                   <span class="o">-</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                  <span class="o">/</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_new_users_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                               <span class="o">-</span>
                                               <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                   <span class="mi">0</span><span class="p">])</span>
                                              <span class="o">/</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                  <span class="mi">0</span><span class="p">],</span>

                        <span class="n">new_users_ads</span><span class="o">=</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_ads'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_new_users_ads_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_ads'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="o">-</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_ads'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                   <span class="o">/</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_ads'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_new_users_ads_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_ads'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                <span class="o">-</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span>
                                                    <span class="s">'new_users_ads'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                               <span class="o">/</span>
                                               <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_ads'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                   <span class="mi">0</span><span class="p">],</span>

                        <span class="n">new_users_org</span><span class="o">=</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_organic'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                           <span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_new_users_org_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_organic'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                      <span class="o">-</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_organic'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                          <span class="mi">0</span><span class="p">])</span>
                                     <span class="o">/</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_organic'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_new_users_org_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span>
                                                         <span class="s">'new_users_organic'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                     <span class="o">-</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span>
                                                         <span class="s">'new_users_organic'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                                    <span class="o">/</span>
                                                    <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span>
                                                        <span class="s">'new_users_organic'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                        <span class="mi">0</span><span class="p">],</span>

                        <span class="n">users_feed</span><span class="o">=</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_feed'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_feed_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_feed'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                          <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_feed'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                         <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_feed'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_feed_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_feed'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_feed'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                          <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_feed'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">likes</span><span class="o">=</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'likes'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_likes_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'likes'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                          <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'likes'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                         <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'likes'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_likes_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'likes'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'likes'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                          <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'likes'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">views</span><span class="o">=</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'views'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_views_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'views'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                          <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'views'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                         <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'views'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_views_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'views'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'views'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                          <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'views'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">ctr</span><span class="o">=</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'CTR'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_ctr_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'CTR'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'CTR'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                       <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'CTR'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_ctr_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'CTR'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                         <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'CTR'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                        <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'CTR'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">users_msg</span><span class="o">=</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_msg_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                               <span class="o">-</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                              <span class="o">/</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_msg_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                <span class="o">-</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                               <span class="o">/</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">msg</span><span class="o">=</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_msg_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                          <span class="o">-</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                         <span class="o">/</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_msg_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                          <span class="o">/</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">mpu</span><span class="o">=</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'mpu'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_mpu_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'mpu'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                          <span class="o">-</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'mpu'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                         <span class="o">/</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'mpu'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_mpu_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'mpu'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'mpu'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                          <span class="o">/</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'mpu'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">)</span>
</code></pre></div></div>

<p>Now we can write a function for graphs:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_plot</span><span class="p">(</span><span class="n">data_feed</span><span class="p">,</span> <span class="n">data_msg</span><span class="p">,</span> <span class="n">data_dau_all</span><span class="p">,</span> <span class="n">data_new_users</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_feed</span><span class="p">,</span> <span class="n">data_msg</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'date'</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_dau_all</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'date'</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_new_users</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'date'</span><span class="p">)</span>

    <span class="n">data</span><span class="p">[</span><span class="s">'events_app'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'events'</span><span class="p">]</span><span class="o">+</span><span class="n">data</span><span class="p">[</span><span class="s">'msg'</span><span class="p">]</span>

    <span class="n">plt_obj_all</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">'Statistics for the entire application for 7 days'</span><span class="p">)</span>
    <span class="n">app_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:{</span><span class="s">'y'</span><span class="p">:</span> <span class="p">[</span><span class="s">'events_app'</span><span class="p">],</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'Events'</span><span class="p">},</span>
                <span class="mi">1</span><span class="p">:{</span><span class="s">'y'</span><span class="p">:</span> <span class="p">[</span><span class="s">'users'</span><span class="p">,</span> <span class="s">'users_ios'</span><span class="p">,</span> <span class="s">'users_and'</span><span class="p">],</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'DAU'</span><span class="p">},</span>
                <span class="mi">2</span><span class="p">:{</span><span class="s">'y'</span><span class="p">:</span> <span class="p">[</span><span class="s">'users'</span><span class="p">,</span> <span class="s">'new_users_ads'</span><span class="p">,</span> <span class="s">'new_users_organic'</span><span class="p">],</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'New users'</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">app_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">'y'</span><span class="p">]:</span>
            <span class="n">sns</span><span class="p">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'date'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="n">app_dict</span><span class="p">[(</span><span class="n">i</span><span class="p">)][</span><span class="s">'title'</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">legend</span><span class="p">(</span><span class="n">app_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">'y'</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">get_xticklabels</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">ind</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">label</span><span class="p">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span><span class="p">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">plt_obj</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plt_obj</span><span class="p">)</span>
    <span class="n">plt_obj</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">'app_stat.png'</span>
    <span class="n">plt_obj</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">plt_obj_all</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt_obj</span><span class="p">)</span>
    <span class="c1">#feed
</span>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">'Statistics on the application feed for 7 days'</span><span class="p">)</span>
    <span class="n">plot_dict</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="p">{</span><span class="s">'y'</span><span class="p">:</span> <span class="s">'users_feed'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'Unique users'</span><span class="p">},</span>
                 <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="p">{</span><span class="s">'y'</span><span class="p">:</span> <span class="s">'likes'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'Likes'</span><span class="p">},</span>
                 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="p">{</span><span class="s">'y'</span><span class="p">:</span> <span class="s">'views'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'Views'</span><span class="p">},</span>
                 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="p">{</span><span class="s">'y'</span><span class="p">:</span> <span class="s">'CTR'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'CTR'</span><span class="p">}}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">sns</span><span class="p">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'date'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)][</span><span class="s">'y'</span><span class="p">])</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_dict</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)][</span><span class="s">'title'</span><span class="p">])</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">].</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">].</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">].</span><span class="n">get_xticklabels</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">label</span><span class="p">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span><span class="p">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">plt_obj</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plt_obj</span><span class="p">)</span>
    <span class="n">plt_obj</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">'feed_stat.png'</span>
    <span class="n">plt_obj</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">plt_obj_all</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt_obj</span><span class="p">)</span>
    <span class="c1">#messenger
</span>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">'Messenger app statistics for 7 days'</span><span class="p">)</span>
    <span class="n">msg_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="s">'y'</span><span class="p">:</span> <span class="s">'users_msg'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'DAU'</span><span class="p">},</span>
                <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s">'y'</span><span class="p">:</span> <span class="s">'msg'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'Messages'</span><span class="p">},</span>
                <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s">'y'</span><span class="p">:</span> <span class="s">'mpu'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'Messages per user'</span><span class="p">}</span>
                <span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">sns</span><span class="p">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'date'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">msg_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">'y'</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="n">msg_dict</span><span class="p">[(</span><span class="n">i</span><span class="p">)][</span><span class="s">'title'</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">get_xticklabels</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">ind</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">label</span><span class="p">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span><span class="p">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">plt_obj</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plt_obj</span><span class="p">)</span>
    <span class="n">plt_obj</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">'msg_stat.png'</span>
    <span class="n">plt_obj</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">plt_obj_all</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt_obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plt_obj_all</span>
</code></pre></div></div>

<p>After I wrote the function for the graph, I added the following lines to the end of the send_telegram_report function and called the function at the very end:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt_obj</span> <span class="o">=</span> <span class="n">get_plot</span><span class="p">(</span><span class="n">data_feed</span><span class="p">,</span> <span class="n">data_msg</span><span class="p">,</span> <span class="n">data_dau_all</span><span class="p">,</span> <span class="n">data_new_users</span><span class="p">)</span>
<span class="n">bot</span><span class="p">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">report</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pl</span> <span class="ow">in</span> <span class="n">plt_obj</span><span class="p">:</span>
    <span class="n">bot</span><span class="p">.</span><span class="n">sendPhoto</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">photo</span><span class="o">=</span><span class="n">pl</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">send_telegram_report</span><span class="p">(</span><span class="n">chat_id</span><span class="p">)</span>
</code></pre></div></div>

<p>Upload the resulting file to any system for automation. As in the last article, I will use GitLab CI/CD. I already have a task for automation there. In this connection, I will create a second task and assign variables to both tasks so that it is possible to automate them in the yml file. Variables should be assigned for the old and new tasks.</p>

<p><img src="https://raw.githubusercontent.com/Zmey56/blog/master/_posts/images/Automation_reporting_2/tel_1.png" alt="image"></p>

<p><img src="https://raw.githubusercontent.com/Zmey56/blog/master/_posts/images/Automation_reporting_2/tel_2.png" alt="image"></p>

<p>After that, I make changes to the yml file and that‚Äôs it. Reports will be sent to our group daily at 11.00 and 11.05:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>image: cr.yandex/crp742p3qacifd2hcon2/practice-da:latest

stages:
  - init
  - run


feed_report_job:
    stage: run
    script:
        - python main.py
    only:
      refs:
        - schedules
      variables:
        - $SCHEDULE_TYPE == "build_feed_report"

app_report_job:
    stage: run
    script:
        - python app_report.py
    only:
      refs:
        - schedules
      variables:
        - $SCHEDULE_TYPE == "build_app_report"
</code></pre></div></div>

<p>The reports in my group as a result of the operation of this algorithm look like this:</p>

<p><img src="https://raw.githubusercontent.com/Zmey56/blog/master/_posts/images/Automation_reporting_2/tel_3.png" alt="image"></p>

<p><img src="https://raw.githubusercontent.com/Zmey56/blog/master/_posts/images/Automation_reporting_2/tel_4.png" alt="image"></p>

<p><img src="https://raw.githubusercontent.com/Zmey56/blog/master/_posts/images/Automation_reporting_2/tel_5.png" alt="image"></p>

<p><img src="https://raw.githubusercontent.com/Zmey56/blog/master/_posts/images/Automation_reporting_2/tel_6.png" alt="image"></p>

<p>As a result of the work done, we managed to create an automated reporting system that provides daily information to the corporate krupp in the telegram channel. In the following final articles, I will review the work in alerts.</p>

<p>Full code:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">telegram</span>
<span class="kn">import</span> <span class="nn">pandahouse</span> <span class="k">as</span> <span class="n">ph</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="n">sns</span><span class="p">.</span><span class="nb">set</span><span class="p">()</span>
<span class="n">bot</span> <span class="o">=</span> <span class="n">telegram</span><span class="p">.</span><span class="n">Bot</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"REPORT_BOT_TOKEN"</span><span class="p">))</span>

<span class="n">chat_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1001592565485</span>

<span class="n">connection</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'host'</span><span class="p">:</span> <span class="s">'https://clickhouse.lab.karpov.courses'</span><span class="p">,</span>
    <span class="s">'password'</span><span class="p">:</span> <span class="s">'dpo_python_2020'</span><span class="p">,</span>
    <span class="s">'user'</span><span class="p">:</span> <span class="s">'student'</span><span class="p">,</span>
    <span class="s">'database'</span><span class="p">:</span> <span class="s">'simulator_20220620'</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">get_plot</span><span class="p">(</span><span class="n">data_feed</span><span class="p">,</span> <span class="n">data_msg</span><span class="p">,</span> <span class="n">data_dau_all</span><span class="p">,</span> <span class="n">data_new_users</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_feed</span><span class="p">,</span> <span class="n">data_msg</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'date'</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_dau_all</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'date'</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_new_users</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'date'</span><span class="p">)</span>

    <span class="n">data</span><span class="p">[</span><span class="s">'events_app'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'events'</span><span class="p">]</span><span class="o">+</span><span class="n">data</span><span class="p">[</span><span class="s">'msg'</span><span class="p">]</span>

    <span class="n">plt_obj_all</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">'Statistics for the entire application for 7 days'</span><span class="p">)</span>
    <span class="n">app_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:{</span><span class="s">'y'</span><span class="p">:</span> <span class="p">[</span><span class="s">'events_app'</span><span class="p">],</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'Events'</span><span class="p">},</span>
                <span class="mi">1</span><span class="p">:{</span><span class="s">'y'</span><span class="p">:</span> <span class="p">[</span><span class="s">'users'</span><span class="p">,</span> <span class="s">'users_ios'</span><span class="p">,</span> <span class="s">'users_and'</span><span class="p">],</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'DAU'</span><span class="p">},</span>
                <span class="mi">2</span><span class="p">:{</span><span class="s">'y'</span><span class="p">:</span> <span class="p">[</span><span class="s">'users'</span><span class="p">,</span> <span class="s">'new_users_ads'</span><span class="p">,</span> <span class="s">'new_users_organic'</span><span class="p">],</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'New users'</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">app_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">'y'</span><span class="p">]:</span>
            <span class="n">sns</span><span class="p">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'date'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="n">app_dict</span><span class="p">[(</span><span class="n">i</span><span class="p">)][</span><span class="s">'title'</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">legend</span><span class="p">(</span><span class="n">app_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">'y'</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">get_xticklabels</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">ind</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">label</span><span class="p">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span><span class="p">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">plt_obj</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plt_obj</span><span class="p">)</span>
    <span class="n">plt_obj</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">'app_stat.png'</span>
    <span class="n">plt_obj</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">plt_obj_all</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt_obj</span><span class="p">)</span>
    <span class="c1">#feed
</span>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">'Statistics on the application feed for 7 days'</span><span class="p">)</span>
    <span class="n">plot_dict</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="p">{</span><span class="s">'y'</span><span class="p">:</span> <span class="s">'users_feed'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'Unique users'</span><span class="p">},</span>
                 <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="p">{</span><span class="s">'y'</span><span class="p">:</span> <span class="s">'likes'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'Likes'</span><span class="p">},</span>
                 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="p">{</span><span class="s">'y'</span><span class="p">:</span> <span class="s">'views'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'Views'</span><span class="p">},</span>
                 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="p">{</span><span class="s">'y'</span><span class="p">:</span> <span class="s">'CTR'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'CTR'</span><span class="p">}}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">sns</span><span class="p">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'date'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)][</span><span class="s">'y'</span><span class="p">])</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_dict</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)][</span><span class="s">'title'</span><span class="p">])</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">].</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">].</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">].</span><span class="n">get_xticklabels</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">label</span><span class="p">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span><span class="p">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">plt_obj</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plt_obj</span><span class="p">)</span>
    <span class="n">plt_obj</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">'feed_stat.png'</span>
    <span class="n">plt_obj</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">plt_obj_all</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt_obj</span><span class="p">)</span>
    <span class="c1">#messenger
</span>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">'Messenger app statistics for 7 days'</span><span class="p">)</span>
    <span class="n">msg_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="s">'y'</span><span class="p">:</span> <span class="s">'users_msg'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'DAU'</span><span class="p">},</span>
                <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s">'y'</span><span class="p">:</span> <span class="s">'msg'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'Messages'</span><span class="p">},</span>
                <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s">'y'</span><span class="p">:</span> <span class="s">'mpu'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'Messages per user'</span><span class="p">}</span>
                <span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">sns</span><span class="p">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'date'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">msg_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">'y'</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="n">msg_dict</span><span class="p">[(</span><span class="n">i</span><span class="p">)][</span><span class="s">'title'</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">get_xticklabels</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">ind</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">label</span><span class="p">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span><span class="p">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">plt_obj</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plt_obj</span><span class="p">)</span>
    <span class="n">plt_obj</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">'msg_stat.png'</span>
    <span class="n">plt_obj</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">plt_obj_all</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt_obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plt_obj_all</span>

<span class="k">def</span> <span class="nf">send_telegram_report</span><span class="p">(</span><span class="n">chat</span><span class="p">):</span>
    <span class="n">chat</span> <span class="o">=</span> <span class="n">chat</span> <span class="ow">or</span> <span class="n">chat_id</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">""" üìÉApplication report for {date}üìÉ
        Events: {events}
        üßëDAU: {users}({to_users_day_ago:+.2%} to day ago, {to_users_week_ago:+.2%} to week ago)
        üßëDAU by platform: 
            üì±IOS: {users_ios}({to_users_ios_day_ago:+.2%} to day ago, {to_users_ios_week_ago:+.2%} to week ago)
            üìûAndroid: {users_and}({to_users_and_day_ago:+.2%} to day ago, {to_users_and_week_ago:+.2%} to week ago)
        üë´DAU by gender: 
            üôéMale: {users_male}({to_users_male_day_ago:+.2%} to day ago, {to_users_male_week_ago:+.2%} to week ago)
            üë∞‚ÄçFemale: {users_female}({to_users_female_day_ago:+.2%} to day ago, {to_users_female_week_ago:+.2%} to week ago)
        üßëNew users: {new_users}({to_new_users_day_ago:+.2%} to day ago, {to_new_users_week_ago:+.2%} to week ago)
        üé¨Source:
            üçãads: {new_users_ads}({to_new_users_ads_day_ago:+.2%} to day ago, {to_new_users_ads_week_ago:+.2%} to week ago)
            üçìorganic: {new_users_org}({to_new_users_org_day_ago:+.2%} to day ago, {to_new_users_org_week_ago:+.2%} to week ago)
        
        FEEDS:
        üßëDAU: {users_feed}({to_users_feed_day_ago:+.2%} to day ago, {to_users_feed_week_ago:+.2%} to week ago)
        üëçLikes: {likes}({to_likes_day_ago:+.2%} to day ago, {to_likes_week_ago:+.2%} to week ago)
        üëÄViews: {views}({to_views_day_ago:+.2%} to day ago, {to_views_week_ago:+.2%} to week ago)
        üåàCTR: {ctr:+.2%}({to_ctr_day_ago:+.2%} to day ago, {to_ctr_week_ago:+.2%} to week ago)
        
        MESSENGER:
        üßëDAU: {users_msg}({to_users_msg_day_ago:+.2%} to day ago, {to_users_msg_week_ago:+.2%} to week ago)
        üì®Messages: {msg} ({to_msg_day_ago:+.2%} to day ago, {to_msg_week_ago:+.2%} to week ago)
        ü™™Messages per users: {mpu:.2}({to_mpu_day_ago:+.2%} to day ago, {to_mpu_week_ago:+.2%} to week ago)
        """</span>

    <span class="n">query_feed_q</span> <span class="o">=</span> <span class="s">"""
                select 
                    toDate(time) as date
                    ,count(distinct user_id) as users_feed
                    ,countIf(action='like') as likes
                    ,countIf(action='view') as views
                    ,countIf(action='like') / countIf(action='view') as CTR
                    ,likes+views as events
                from simulator_20220620.feed_actions
                where toDate(time) between today() - 8 and today() - 1
                group by date
                order by date
                """</span>

    <span class="n">data_feed</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ph</span><span class="p">.</span><span class="n">read_clickhouse</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_feed_q</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">))</span>

    <span class="n">query_msg_q</span> <span class="o">=</span> <span class="s">"""
                  select 
                      toDate(time) as date
                      ,count(distinct user_id) as users_msg
                      ,count(user_id) as msg
                      , msg / users_msg as mpu
                  from simulator_20220620.message_actions
                  where toDate(time) between today() - 8 and today() - 1
                  group by date
                  order by date
                  """</span>
    <span class="n">data_msg</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ph</span><span class="p">.</span><span class="n">read_clickhouse</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_msg_q</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">))</span>

    <span class="n">query_dau_all_q</span> <span class="o">=</span> <span class="s">"""select date, 
                                uniqExact(user_id) as users, 
                                uniqExactIf(user_id, os='iOS') as users_ios, 
                                uniqExactIf(user_id, os='Android') as users_and, 
                                uniqExactIf(user_id, gender=1) as users_male,
                                uniqExactIf(user_id, gender=0) as users_female
                        from
                            (select distinct toDate(time) as date, user_id, os, gender
                            from simulator_20220620.feed_actions
                            where toDate(time) between today() - 8 and today() - 1
                            union all
                            select distinct toDate(time) as date, user_id, os, gender
                            from simulator_20220620.message_actions
                            where toDate(time) between today() - 8 and today() - 1) as t
                        group by date
                        order by date"""</span>

    <span class="n">data_dau_all</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ph</span><span class="p">.</span><span class="n">read_clickhouse</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_dau_all_q</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">))</span>

    <span class="n">data_new_users_q</span> <span class="o">=</span> <span class="s">"""
    select date, 
            uniqExact(user_id) as new_users, 
            uniqExactIf(user_id, source='ads') as new_users_ads,
            uniqExactIf(user_id, source='organic') as new_users_organic
    from(
        select user_id,
                source, 
                min(dt_reg) as date 
        from
            (select user_id, 
                    min(toDate(time)) as dt_reg, 
                    source
            from simulator_20220620.feed_actions
            where toDate(time) between today() - 8 and today() - 1
            group by user_id, source
            union all
            select user_id,
                    min(toDate(time)) as dt_reg, 
                    source
            from simulator_20220620.message_actions
            where toDate(time) between today() - 8 and today() - 1
            group by user_id, source) as t1
        group by user_id, source) as t2
    where date between today() - 8 and today() - 1
    group by date
    """</span>
    <span class="n">data_new_users</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ph</span><span class="p">.</span><span class="n">read_clickhouse</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">data_new_users_q</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">))</span>

    <span class="n">today</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s">'now'</span><span class="p">)</span> <span class="o">-</span> <span class="n">pd</span><span class="p">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">day_ago</span> <span class="o">=</span> <span class="n">today</span> <span class="o">-</span> <span class="n">pd</span><span class="p">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">week_ago</span> <span class="o">=</span> <span class="n">today</span> <span class="o">-</span> <span class="n">pd</span><span class="p">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

    <span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]).</span><span class="n">dt</span><span class="p">.</span><span class="n">date</span>
    <span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]).</span><span class="n">dt</span><span class="p">.</span><span class="n">date</span>
    <span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]).</span><span class="n">dt</span><span class="p">.</span><span class="n">date</span>
    <span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]).</span><span class="n">dt</span><span class="p">.</span><span class="n">date</span>

    <span class="n">data_feed</span> <span class="o">=</span> <span class="n">data_feed</span><span class="p">.</span><span class="n">astype</span><span class="p">({</span><span class="s">'users_feed'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'likes'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'views'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'events'</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
    <span class="n">data_msg</span> <span class="o">=</span> <span class="n">data_msg</span><span class="p">.</span><span class="n">astype</span><span class="p">({</span><span class="s">'users_msg'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'msg'</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
    <span class="n">data_dau_all</span> <span class="o">=</span> <span class="n">data_dau_all</span><span class="p">.</span><span class="n">astype</span><span class="p">({</span><span class="s">'users'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'users_ios'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'users_and'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'users_male'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'users_female'</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
    <span class="n">data_new_users</span> <span class="o">=</span> <span class="n">data_new_users</span><span class="p">.</span><span class="n">astype</span><span class="p">({</span><span class="s">'new_users'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'new_users_ads'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">'new_users_organic'</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>

    <span class="n">report</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">(),</span>
                        <span class="n">events</span><span class="o">=</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'events'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">users</span><span class="o">=</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_day_ago</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                           <span class="o">/</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_week_ago</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                           <span class="o">/</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">users_ios</span><span class="o">=</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_ios'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_ios_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_ios'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                          <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_ios'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                         <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_ios'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_ios_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_ios'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_ios'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                          <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_ios'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">users_and</span><span class="o">=</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_and'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_and_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_and'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                   <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_and'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                  <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_and'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_and_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_and'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                               <span class="o">-</span>
                                               <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_and'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                   <span class="mi">0</span><span class="p">])</span>
                                              <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_and'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                  <span class="mi">0</span><span class="p">],</span>

                        <span class="n">users_male</span><span class="o">=</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_male'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_male_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_male'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                   <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_male'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                  <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_male'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_male_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_male'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                               <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_male'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                              <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_male'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">users_female</span><span class="o">=</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_female'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_female_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_female'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                   <span class="o">-</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_female'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                  <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_female'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_female_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_female'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                               <span class="o">-</span>
                                               <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_female'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                   <span class="mi">0</span><span class="p">])</span>
                                              <span class="o">/</span> <span class="n">data_dau_all</span><span class="p">[</span><span class="n">data_dau_all</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_female'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                  <span class="mi">0</span><span class="p">],</span>

                        <span class="n">new_users</span><span class="o">=</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_new_users_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                   <span class="o">-</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                  <span class="o">/</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_new_users_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                               <span class="o">-</span>
                                               <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                   <span class="mi">0</span><span class="p">])</span>
                                              <span class="o">/</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                  <span class="mi">0</span><span class="p">],</span>

                        <span class="n">new_users_ads</span><span class="o">=</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_ads'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_new_users_ads_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_ads'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="o">-</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_ads'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                   <span class="o">/</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_ads'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_new_users_ads_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_ads'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                <span class="o">-</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span>
                                                    <span class="s">'new_users_ads'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                               <span class="o">/</span>
                                               <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_ads'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                   <span class="mi">0</span><span class="p">],</span>

                        <span class="n">new_users_org</span><span class="o">=</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_organic'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                           <span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_new_users_org_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_organic'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                      <span class="o">-</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_organic'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                          <span class="mi">0</span><span class="p">])</span>
                                     <span class="o">/</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'new_users_organic'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_new_users_org_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span>
                                                         <span class="s">'new_users_organic'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                     <span class="o">-</span> <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span>
                                                         <span class="s">'new_users_organic'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                                    <span class="o">/</span>
                                                    <span class="n">data_new_users</span><span class="p">[</span><span class="n">data_new_users</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span>
                                                        <span class="s">'new_users_organic'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span>
                                                        <span class="mi">0</span><span class="p">],</span>

                        <span class="n">users_feed</span><span class="o">=</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_feed'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_feed_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_feed'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                          <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_feed'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                         <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_feed'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_feed_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_feed'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_feed'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                          <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_feed'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">likes</span><span class="o">=</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'likes'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_likes_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'likes'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                          <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'likes'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                         <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'likes'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_likes_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'likes'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'likes'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                          <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'likes'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">views</span><span class="o">=</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'views'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_views_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'views'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                          <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'views'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                         <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'views'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_views_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'views'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'views'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                          <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'views'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">ctr</span><span class="o">=</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'CTR'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_ctr_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'CTR'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'CTR'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                       <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'CTR'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_ctr_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'CTR'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                         <span class="o">-</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'CTR'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                        <span class="o">/</span> <span class="n">data_feed</span><span class="p">[</span><span class="n">data_feed</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'CTR'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">users_msg</span><span class="o">=</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_msg_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                               <span class="o">-</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                              <span class="o">/</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_users_msg_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                <span class="o">-</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                               <span class="o">/</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'users_msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">msg</span><span class="o">=</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_msg_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                          <span class="o">-</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                         <span class="o">/</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_msg_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                          <span class="o">/</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'msg'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>

                        <span class="n">mpu</span><span class="o">=</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'mpu'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_mpu_day_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'mpu'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                          <span class="o">-</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'mpu'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                         <span class="o">/</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">day_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'mpu'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">to_mpu_week_ago</span><span class="o">=</span><span class="p">(</span><span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">today</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'mpu'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="o">-</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'mpu'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                          <span class="o">/</span> <span class="n">data_msg</span><span class="p">[</span><span class="n">data_msg</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">==</span> <span class="n">week_ago</span><span class="p">.</span><span class="n">date</span><span class="p">()][</span><span class="s">'mpu'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">)</span>
    <span class="n">plt_obj</span> <span class="o">=</span> <span class="n">get_plot</span><span class="p">(</span><span class="n">data_feed</span><span class="p">,</span> <span class="n">data_msg</span><span class="p">,</span> <span class="n">data_dau_all</span><span class="p">,</span> <span class="n">data_new_users</span><span class="p">)</span>
    <span class="n">bot</span><span class="p">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">report</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pl</span> <span class="ow">in</span> <span class="n">plt_obj</span><span class="p">:</span>
        <span class="n">bot</span><span class="p">.</span><span class="n">sendPhoto</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">photo</span><span class="o">=</span><span class="n">pl</span><span class="p">)</span>


<span class="n">send_telegram_report</span><span class="p">(</span><span class="n">chat_id</span><span class="p">)</span>

</code></pre></div></div>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="Zmey56/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/data%20analysis/mysql/gitlab/telegram/bot/2022/09/02/Automation-of-reporting-copy-Part-2.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="https://zmey56.github.io/blog//feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>An easy to use blogging platform with support for Jupyter Notebooks.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://twitter.com/zmey56" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://github.com/Zmey56" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.linkedin.com/in/alsgladkikh/" target="_blank" title="linkedin">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
